<div class="admin-wrap">
  <header class="page-head">
    <h2>Upload Music Content</h2>
    <p>Upload audio files and define metadata.</p>
  </header>

  <section class="card grid">
    <!-- LEFT: File upload section -->
    <div class="col">
      <h3>File(s)</h3>

      <!-- Dropzone for audio files -->
      <div class="dropzone" (dragover)="onDragOver($event)" (drop)="onDrop($event)">
        <p>Drag & drop audio files here, or</p>
        <button mat-stroked-button color="accent" (click)="fileInput.click()">Browse files</button>
        <input #fileInput type="file" multiple accept="audio/*" (change)="onFilesSelected($event)" hidden>
      </div>

      <!-- Uploaded files list -->
      <div class="file-list" *ngIf="files.length">
        <h4>Uploaded files</h4>
        <table>
          <thead>
            <tr><th>Name</th><th>Size</th><th>Type</th><th>Created</th><th>Last Modified</th><th></th></tr>
          </thead>
          <tbody>
            <tr *ngFor="let f of files; let i=index">
              <td>{{ f.name }}</td>
              <td>{{ f.size | number }} B</td>
              <td>{{ f.type }}</td>
              <td>{{ f.lastModified | date:'short' }}</td> <!-- Approximation for creation time; actual creation might need metadata lib -->
              <td>{{ f.lastModified | date:'short' }}</td>
              <td><button class="link" type="button" (click)="remove(i)">Remove</button></td>
            </tr>
          </tbody>
        </table>
      </div>
      <br>
      <!-- Cover image upload -->
      <h3>Cover Image</h3>
      <div class="dropzone" (dragover)="onDragOver($event)" (drop)="onCoverDrop($event)">
        <p>Drag & drop cover image here, or</p>
        <button mat-stroked-button color="accent" (click)="coverInput.click()">Browse image</button>
        <input #coverInput type="file" accept="image/*" (change)="onCoverSelected($event)" hidden>
      </div>
      
      <!-- Cover preview -->
      <div *ngIf="coverPreview" class="cover-preview">
        <img [src]="coverPreview" alt="Cover preview">
        <button class="link" type="button" (click)="removeCover()">Remove</button>
      </div>
      <br>

      <h3>Single Images for your album</h3>
      <div class="dropzone" (dragover)="onDragOver($event)" (drop)="onSingleAlbumCoverDrop($event)">
        <p>Drag & drop cover image here, or</p>
        <button mat-stroked-button color="accent" (click)="singleCoverInput.click()">Browse image</button>
        <input #singleCoverInput type="file" accept="image/*" (change)="onSingleCoverSelected($event)" hidden>
      </div>

      <!-- Cover preview -->
      <div *ngIf="singleCoverPreview" class="cover-preview">
        <img [src]="singleCoverPreview" alt="Cover preview">
        <button class="link" type="button" (click)="removeSingleCover()">Remove</button>
      </div>
      
    </div>
    

    <!-- RIGHT: Metadata section -->
    <div class="col">
      <h3>Metadata</h3>

      <mat-tab-group [(selectedIndex)]="tabIndex" class="tabs">
        <!-- SINGLE TAB -->
        <mat-tab label="Add Single">
          <form [formGroup]="singleForm" (ngSubmit)="submitSingle()" class="nice-form">
            <div class="row">
              <mat-form-field appearance="outline" class="full">
                <mat-label>Single title</mat-label>
                <input matInput formControlName="title" required>
              </mat-form-field>
            </div>

            <div class="row">
              <mat-form-field appearance="outline" class="full">
                <mat-label>Genres</mat-label>
                <mat-select formControlName="genres" multiple>
                  <mat-option *ngFor="let genre of availableGenres" [value]="genre.genreName">{{ genre.genreName }}</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
    

            <div class="row">
              <mat-form-field appearance="outline" class="full">
                <mat-label>Artists</mat-label>
                <mat-select formControlName="artistIds" multiple>
                  <mat-option *ngFor="let a of availableArtists" [value]="a.artistId">
                    {{ a.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <div class="row toggle-row">
              <mat-slide-toggle formControlName="explicit">Explicit content</mat-slide-toggle>
            </div>

            <div class="row actions">
              <button mat-raised-button color="primary" type="submit"
                      [disabled]="!files.length || singleForm.invalid || isSubmittingSingle">
                Save metadata & upload
              </button>
              <button mat-stroked-button type="button" (click)="resetSingle()">Reset</button>
            </div>
          </form>
        </mat-tab>

        <!-- ALBUM TAB -->
        <mat-tab label="Add Album">
          <div class="wizard">
            <!-- STEP 0: album info -->
            <form *ngIf="albumStep===0" [formGroup]="albumForm" class="nice-form">
              <div class="row">
                <mat-form-field appearance="outline" class="full">
                  <mat-label>Album title</mat-label>
                  <input matInput formControlName="title" required>
                </mat-form-field>
              </div>

              <div class="row">
                <mat-form-field appearance="outline" class="full">
                  <mat-label>Genres</mat-label>
                  <mat-select formControlName="genres" multiple>
                    <mat-option *ngFor="let genre of availableGenres" [value]="genre.genreName">{{ genre.genreName }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="row">
                <mat-form-field appearance="outline" class="full">
                  <mat-label>Artists</mat-label>
                  <mat-select formControlName="artistIds" multiple>
                    <mat-option *ngFor="let a of availableArtists" [value]="a.artistId">             
                      {{ a.name }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="row actions">
                <button mat-raised-button color="primary"
                        [disabled]="albumForm.invalid"
                        (click)="goToSingles()">Next</button>
                <button mat-stroked-button type="button" (click)="resetAlbum()">Reset</button>
              </div>
            </form>

            <!-- STEP 1: add singles -->
            <div *ngIf="albumStep===1" class="nice-form">
              <form [formGroup]="albumSingleForm" (ngSubmit)="addAlbumSingle()">
                <div class="row">
                  <mat-form-field appearance="outline" class="full">
                    <mat-label>Single title</mat-label>
                    <input matInput formControlName="title" required>
                  </mat-form-field>
                </div>

                <div class="row">
                  <mat-form-field appearance="outline" class="full">
                    <mat-label>Genres</mat-label>
                    <mat-select formControlName="genres" multiple>
                      <mat-option *ngFor="let genre of availableGenres" [value]="genre.genreName">{{ genre.genreName }}</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
                  
                <div class="row">
                  <mat-form-field appearance="outline" class="full">
                    <mat-label>Artists</mat-label>
                    <mat-select formControlName="artistIds" multiple>
                      <mat-option *ngFor="let a of availableArtists" [value]="a.artistId">
                        {{ a.name }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <div class="row">
                  <mat-form-field appearance="outline" class="full">
                    <mat-label>Audio file (from left list)</mat-label>
                    <mat-select formControlName="fileIndex" required>
                      <mat-option *ngFor="let f of files; let i=index" [value]="i">
                        {{ f.name }} ({{ f.size | number }} B)
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <div class="row actions">
                  <button mat-raised-button color="primary" type="submit" [disabled]="albumSingleForm.invalid">
                    Add single
                  </button>
                  <button mat-stroked-button type="button" (click)="backToAlbum()">Back</button>
                </div>
              </form>

              <div class="file-list" *ngIf="albumSingles.length">
                <h4>Singles queued</h4>
                <table>
                  <thead>
                    <tr><th>#</th><th>Title</th><th>File</th><th>Artists</th><th>Genres</th><th></th></tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let s of albumSingles; let i=index">
                      <td>{{ i+1 }}</td>
                      <td>{{ s.title }}</td>
                      <td>{{ files[s.fileIndex]?.name }}</td>
                      <td>{{ renderArtistNames(s.artistIds) }}</td>
                      <td>{{ s.genres.join(', ') }}</td>
                      <td><button class="link" type="button" (click)="removeAlbumSingle(i)">Remove</button></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="row actions">
                <button mat-stroked-button type="button" (click)="albumSingleForm.reset({title:'',genres:[],artistIds:[],fileIndex:null})">
                  Add another
                </button>
                <button mat-raised-button color="primary"
                        [disabled]="!albumSingles.length || isSubmittingAlbum"
                        (click)="submitAlbumWizard()">
                  Save album
                </button>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  </section>
</div>